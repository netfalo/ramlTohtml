{{ if .resource.methods or .resource.description and .resource.parentUrl }}
  <div class="panel panel-white resource-modal">
    <div class="panel-heading">
      <h4 class="panel-title">
        <a class="collapsed" data-toggle="collapse" href="#panel_{{ .resource.uniqueId }}">
          <span class="parent">{{ .resource.parentUrl }}</span>{{ .resource.relativeUri }}
        </a>

        <span class="methods">
          {{ range $method := .resource.methods }}
            <a href="#{{ .resource.uniqueId }}_{{ $method.method }}"><!-- modal shown by hashchange event -->
              <span class="badge badge_{{ $method.method }}">{{ $method.method }}{{ if $method.securedBy.length }} <span class="glyphicon glyphicon-lock" title="Authentication required"></span>{{end}}</span>
            </a>
          {{end}}
        </span>
      </h4>
    </div>

    <div id="panel_{{ .resource.uniqueId }}" class="panel-collapse collapse">
      <div class="panel-body">
        {{ if .resource.parentUrl }}
          {{ if .resource.description }}
            <div class="resource-description">
{% markdown %}
{{ .resource.description }}
{% endmarkdown %}
            </div>
          {{end}}
        {{end}}

        <div class="list-group">
          {{ range $method := .resource.methods }}
            <div onclick="window.location.href = '#{{ .resource.uniqueId }}_{{ $method.method }}'" class="list-group-item">
              <span class="badge badge_{{ $method.method }}">{{ $method.method }}{{ if $method.securedBy.length }} <span class="glyphicon glyphicon-lock" title="Authentication required"></span>{{end}}</span>
              <div class="method_description">
{% markdown %}
{{ $method.description}}
{% endmarkdown %}
              </div>
              <div class="clearfix"></div>
            </div>
          {{end}}
        </div>
      </div>
    </div>

    {{ range $method := .resource.methods }}
      <div class="modal fade" tabindex="0" id="{{ .resource.uniqueId }}_{{ $method.method }}">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
              <h4 class="modal-title" id="myModalLabel">
                <span class="badge badge_{{ $method.method }}">{{ $method.method }}{{ if $method.securedBy.length }} <span class="glyphicon glyphicon-lock" title="Authentication required"></span>{{end}}</span>
                <span class="parent">{{ .resource.parentUrl }}</span>{{ .resource.relativeUri }}
              </h4>
            </div>

            <div class="modal-body">
              {{ if $method.description }}
                <div class="alert alert-info">
{% markdown %}
{{ $method.description}}
{% endmarkdown %}
                </div>
              {{end}}

                {{ if $method.securedBy.length }}
                {{ range $securedBy := $method.securedBy }}
                  {{ if $securedBy }}
                    <div class="alert alert-warning">
                      {{ $securityScheme := index .securitySchemes $securedBy.schemeName }}
                      <span class="glyphicon glyphicon-lock" title="Authentication required"></span>
                      Secured by <b>{{$securityScheme.displayName}}</b>
                      {{ if $securedBy.scopes }}
                        with scopes:
                        <ul>
                          {{ range $scope := $securedBy.scopes }}
                            <li>{{$scope}}</li>
                          {{end}}
                        </ul>
                      {{end}}
                      {{ if $securityScheme.description }}
{% markdown %}
{{ $securityScheme.description }}
{% endmarkdown %}
                      {{end}}
                    </div>
                  {{end}}
                {{end}}
              {{end}}

              <!-- Nav tabs -->
              <ul class="nav nav-tabs">
                {{ if $method.allUriParameters.length or $method.queryString or $method.queryParameters or $method.headers or $method.body }}
                  <li class="active">
                    <a href="#{{ .resource.uniqueId }}_{{ $method.method }}_request" data-toggle="tab">Request</a>
                  </li>
                {{end}}

                {{ if $method.responses }}
                  <li{{if not $method.allUriParameters.length and not $method.queryParameters and not $method.queryString and not $method.headers and not $method.body}}class="active"{{end}}>
                    <a href="#{{ .resource.uniqueId }}_{{ $method.method }}_response" data-toggle="tab">Response</a>
                  </li>
                {{end}}

                {{ if $method.securedBy.length }}
                  <li>
                    <a href="#{{ .resource.uniqueId }}_{{ $method.method }}_securedby" data-toggle="tab">Security</a>
                  </li>
                {{end}}
              </ul>

              <!-- Tab panes -->
              <div class="tab-content">
                {{ if $method.allUriParameters.length or $method.queryString or $method.queryParameters or $method.headers or $method.body }}
                  <div class="tab-pane active" id="{{ .resource.uniqueId }}_{{ $method.method }}_request">
                    {{ if .resource.allUriParameters.length }}
                      <h3>URI Parameters</h3>
                      <ul>
                        {{ range $item := .resource.allUriParameters }}
                        {{template "item" $item }}
                        {{end}}
                      </ul>
                    {{end}}

                    {{ if $method.annotations.length }}
                      <h3>Annotations</h3>
                      <ul>
                        {{ range $item := $method.annotations }}
                          {{template "item" $item }}
                        {{end}}
                      </ul>
                    {{end}}

                    {{ if $method.headers.length }}
                      <h3>Headers</h3>
                      <ul>
                        {{range $item := $method.headers}}
                        {{template "item" $item }}
                        {{end}}
                      </ul>
                    {{end}}

                    {{ if $method.queryString and $method.queryString.properties.length }}
                      <h3>Query String</h3>
                      <ul>
                        {{ range $item := $method.queryString.properties }}
                          {{template "item" $item }}
                        {{end}}
                      </ul>
                    {{end}}

                    {{ if $method.queryParameters.length }}
                      <h3>Query Parameters</h3>
                      <ul>
                        {{ range $item := $method.queryParameters }}
                          {{template "item" $item }}
                        {{end}}
                      </ul>
                    {{end}}

                    {{ if $method.body }}
                      <h3>Body</h3>
                      {{ range $b :=$method.body }}
                        <p><strong>Media type</strong>: {{ .b.key }}</p>

                        {{ if $b.type }}
                          {{ if isStandardType $b.type }}
                            {{ if $b.type eq "array" and $b.items }}
                              <p><strong>Type</strong>: array of {{ if isStandardType(b.items) }}{{ .b.items }}{{else}}{{ .b.items.displayName }}{{end}}</p>
                            {{ elif b.type === 'union' and b.anyOf.length }}
                              <p><strong>Possible types</strong>:
                                <ul>
                                  {{ range super in b.anyOf }}
                                    <li>
                                      <p><strong>{{ .super.displayName }}</strong></p>
                                      <div class="items">
                                        <ul>
                                          {{ range $item := super.properties }}
                                            {{template "item" $item }}
                                          {{end}}
                                        </ul>
                                      </div>
                                    </li>
                                  {{end}}
                                </ul>
                              </p>
                            {{else}}
                              <p><strong>Type</strong>: {{ .b.type }}</p>
                            {{end}}
                          {{else}}
                            <p><strong>Type</strong>:</p>
                            <pre><code>{{ .b.type | .escape }}</code></pre>
                          {{end}}
                        {{end}}

                        {{ if b.content }}
                          <p><strong>Content</strong>:</p>
                          <pre><code>{{ .b.content | .escape }}</code></pre>
                        {{end}}

                        {{ if b.items and b.items.properties }}
                          {{ if isStandardType(b.items) }}
                            <p><strong>Items</strong>: {{ .b.items }}</p>
                          {{end}}

                          {{ if not isStandardType(b.items) }}
                            <p><strong>Items</strong>: {{ b.items.displayName }}</p>

                            {{ if b.items.properties or b.items.examples.length }}
                              <div class="items">
                                {{ if b.items.properties }}
                                  <ul>
                                    {{ range $item := b.items.properties }}
                                      {{template "item" $item }}
                                    {{end}}
                                  </ul>
                                {{end}}

                                {# Request - Array item examples #}
                                {{ set parent = b.items }}
                                {{ include "./examples.nunjucks" }}
                              </div>
                            {{end}}
                          {{end}}
                        {{end}}

                        {{ if b.properties.length }}
                          <strong>Properties</strong>
                          <ul>
                            {{ range $item := b.properties }}
                              {{template "item" $item }}
                            {{end}}
                          </ul>
                        {{end}}

                        {# Request - Body examples #}
                        {{ set parent = b }}
                        {{ include "./examples.nunjucks" }}
                      {{end}}
                    {{end}}
                  </div>
                {{end}}

                {{ if $method.responses }}
                  <div class="tab-pane{{
                    if not $method.allUriParameters.length and not $method.queryParameters.length
                    and not $method.queryString
                    and not $method.headers.length and not $method.body.length
                    }} active{{
                    endif
                    }}" id="{{ .resource.uniqueId }}_{{ .method.method }}_response">
                    {{ range response in $method.responses }}
                      <h2>HTTP status code <a href="http://httpstatus.es/{{ response.code }}" target="_blank">{{ response.code }}</a></h2>
{% markdown %}
{{ response.description }}
{% endmarkdown %}

                      {{ if response.headers.length }}
                        <h3>Headers</h3>
                        <ul>
                          {{ range $item := response.headers }}
                            {{template "item" $item }}
                          {{end}}
                        </ul>
                      {{end}}

                      {{ if response.body.length }}
                        <h3>Body</h3>
                        {{ range $b :=response.body }}
                          <p><strong>Media type</strong>: {{ b.key }}</p>

                          {{ if b.type }}
                            {{ if isStandardType(b.type) }}
                              {{ if b.type === 'array' and b.items }}
                                <p><strong>Type</strong>: array of {{ if isStandardType(b.items) }}{{ b.items }}{{else}}{{ b.items.displayName }}{{end}}</p>
                              {{ elif b.type === 'union' and b.anyOf.length }}
                                <p><strong>Possible types</strong>:
                                  <ul>
                                    {{ range super in b.anyOf }}
                                      <li>
                                        <p><strong>{{ super.displayName }}</strong></p>
                                        <div class="items">
                                          <ul>
                                            {{ range $item := super.properties }}
                                              {{template "item" $item }}
                                            {{end}}
                                          </ul>
                                        </div>
                                      </li>
                                    {{end}}
                                  </ul>
                                </p>
                              {{else}}
                                <p><strong>Type</strong>: {{ b.type }}</p>
                              {{end}}
                            {{else}}
                              <p><strong>Type</strong>:</p>
                              <pre><code>{{ b.type | escape }}</code></pre>
                            {{end}}
                          {{end}}

                          {{ if b.content }}
                            <p><strong>Content</strong>:</p>
                            <pre><code>{{ b.content | escape }}</code></pre>
                          {{end}}

                          {{ if b.items and b.items.properties }}
                            {{ if isStandardType(b.items) }}
                              <p><strong>Items</strong>: {{ b.items }}</p>
                            {{end}}

                            {{ if not isStandardType(b.items) }}
                              <p><strong>Items</strong>: {{ b.items.displayName }}</p>

                              {{ if b.items.properties or b.items.examples.length }}
                                <div class="items">
                                  {{ if b.items.properties }}
                                    <ul>
                                      {{ range $item := b.items.properties }}
                                        {{template "item" $item }}
                                      {{end}}
                                    </ul>
                                  {{end}}

                                  {# Response - Array item examples #}
                                  {{ set parent = b.items.examples }}
                                  {{ include "./examples.nunjucks" }}
                                </div>
                              {{end}}
                            {{end}}
                          {{end}}

                          {{ if b.properties.length }}
                            <strong>Properties</strong>
                            <ul>
                              {{ range $item := b.properties }}
                                {{template "item" $item }}
                              {{end}}
                            </ul>
                          {{end}}

                          {# Response - Body examples #}
                          {{ set parent = b }}
                          {{ include "./examples.nunjucks" }}
                        {{end}}
                      {{end}}
                    {{end}}
                  </div>
                {{end}}

                {{ if $method.securedBy.length }}
                  <div class="tab-pane" id="{{ .resource.uniqueId }}_{{ .method.method }}_securedby">
                    {{ range securedBy in $method.securedBy }}
                      {{ set securityScheme = securitySchemes[securedBy.schemeName] }}
                      <h1>Secured by {{ securityScheme.displayName }}</h1>

                      {{ if securityScheme.describedBy.headers.length }}
                        <h3>Headers</h3>
                        <ul>
                          {{ range $item := securityScheme.describedBy.headers }}
                            {{template "item" $item}}
                          {{end}}
                        </ul>
                      {{end}}

                      {{ if securityScheme.describedBy.queryParameters.length }}
                        <h3>Query Parameters</h3>
                        <ul>
                          {{ range $item := securityScheme.describedBy.queryParameters }}
                            {{template "item" $item}}
                          {{end}}
                        </ul>
                      {{end}}

                      {{ range response in securityScheme.describedBy.responses }}
                        <h2>HTTP status code <a href="http://httpstatus.es/{{ response.code }}" target="_blank">{{ response.code }}</a></h2>
{% markdown %}
{{ response.description }}
{% endmarkdown %}
                        {{ if response.headers.length }}
                          <h3>Headers</h3>
                          <ul>
                            {{ range $item := response.headers }}
                            {{template "item" $item}}
                            {{end}}
                          </ul>
                        {{end}}

                        {{ if response.body.length }}
                          <h3>Body</h3>
                          {{ range $b := response.body }}
                            <p><strong>Media type</strong>: {{ b.key }}</p>

                            {{ if b.type }}
                              {{ if isStandardType(b.type) }}
                                {{ if b.type === 'array' and b.items }}
                                  <p><strong>Type</strong>: array of {{ if isStandardType(b.items) }}{{ b.items }}{{else}}{{ b.items.displayName }}{{end}}</p>
                                {{ elif b.type === 'union' and b.anyOf.length }}
                                  <p><strong>Possible types</strong>:
                                    <ul>
                                      {{ range super in b.anyOf }}
                                        <li>
                                          <p><strong>{{ super.displayName }}</strong></p>
                                          <div class="items">
                                            <ul>
                                              {{ range $item := $super.properties }}
                                              {{template "item" $item}}
                                              {{end}}
                                            </ul>
                                          </div>
                                        </li>
                                      {{end}}
                                    </ul>
                                  </p>
                                {{else}}
                                  <p><strong>Type</strong>: {{ b.type }}</p>
                                {{end}}
                              {{else}}
                                <p><strong>Type</strong>:</p>
                                <pre><code>{{ b.type | escape }}</code></pre>
                              {{end}}
                            {{end}}

                            {{ if b.content }}
                              <p><strong>Content</strong>:</p>
                              <pre><code>{{ b.content | escape }}</code></pre>
                            {{end}}

                            {{ if b.items and b.items.properties }}
                              {{ if isStandardType(b.items) }}
                                <p><strong>Items</strong>: {{ b.items }}</p>
                              {{end}}

                              {{ if not isStandardType(b.items) }}
                                <p><strong>Items</strong>: {{ b.items.displayName }}</p>

                                {{ if b.items.properties or b.items.examples.length }}
                                  <div class="items">
                                    {{ if b.items.properties }}
                                      <ul>
                                        {{ range $item := b.items.properties }}
                                        {{template "item" $item}}
                                        {{end}}
                                      </ul>
                                    {{end}}

                                    {# Response - Array item examples #}
                                      {{ $parent := b.items.examples }}
                                      {{template "examples" $parent}}
                                  </div>
                                {{end}}
                              {{end}}
                            {{end}}

                            {{ if $b.properties.length }}
                              <strong>Properties</strong>
                              <ul>
                                {{range $item := $b.properties }}
                                  {{template "item" $item}}
                                {{end}}
                              </ul>
                            {{end}}

                            {# Response - Body examples #}
                            {{ $parent := .b }}
                            {{template "resource" $resource }}
                          {{end}}
                        {{end}}

                      {{end}}

                    {{end}}
                  </div>
                {{end}}
              </div>
            </div>
          </div>
        </div>
      </div>
    {{end}}
  </div>
{{end}}

{{range $resource := .resource.resources }}
  {{template "resource" $resource }}
{{end}}
